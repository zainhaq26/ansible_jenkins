---
- name: Get Coffee Orders from Coffee Shop API
  hosts: localhost
  gather_facts: no
  vars:
    coffee_shop_url: "http://localhost:8000"
    order_id: null  # Set to a specific order ID to get one order, or leave null for all orders

  tasks:
    - name: Check if coffee shop API is available
      uri:
        url: "{{ coffee_shop_url }}/health"
        method: GET
        status_code: 200
      register: health_check
      failed_when: false

    - name: Display health check status
      debug:
        msg: "Coffee Shop API is {{ 'healthy' if health_check.status == 200 else 'unavailable' }}"

    - name: Get specific order by ID
      uri:
        url: "{{ coffee_shop_url }}/orders/{{ order_id }}"
        method: GET
        status_code: 200
      register: order_response
      when: order_id is not none

    - name: Get all orders
      uri:
        url: "{{ coffee_shop_url }}/orders"
        method: GET
        status_code: 200
      register: orders_response
      when: order_id is none

    - name: Display specific order details
      debug:
        msg:
          - "=== Order Details ==="
          - "Order ID: {{ order_response.json.order_id }}"
          - "Size: {{ order_response.json.size }}"
          - "Type: {{ order_response.json.coffee_type }}"
          - "Flavors: {{ order_response.json.flavors | default([]) | join(', ') or 'None' }}"
          - "Milk: {{ order_response.json.milk | default('None') }}"
          - "Extra Shots: {{ order_response.json.extra_shot | default(0) }}"
          - "Special Instructions: {{ order_response.json.special_instructions | default('None') }}"
          - "Estimated Price: ${{ order_response.json.estimated_price }}"
          - "Estimated Prep Time: {{ order_response.json.estimated_prep_time }} minutes"
          - "Status: {{ order_response.json.status }}"
          - "Order Time: {{ order_response.json.order_time }}"
      when: order_id is not none

    - name: Display all orders summary
      debug:
        msg:
          - "=== All Orders ({{ orders_response.json | length }} total) ==="
          - "{{ orders_response.json | to_nice_json }}"
      when: order_id is none

    - name: Display all orders in table format
      debug:
        msg:
          - "=== Orders Summary ==="
          - "Total Orders: {{ orders_response.json | length }}"
          - ""
          - "Order ID | Size | Type | Price | Status"
          - "{{ '-' * 60 }}"
          - "{{ item.order_id[:8] }}... | {{ item.size }} | {{ item.coffee_type }} | ${{ item.estimated_price }} | {{ item.status }}"
      loop: "{{ orders_response.json }}"
      when: order_id is none

    # - name: Display each order in table format
    #   debug:
    #     msg: "{{ item.order_id[:8] }}... | {{ item.size }} | {{ item.coffee_type }} | ${{ item.estimated_price }} | {{ item.status }}"
    #   loop: "{{ orders_response.json }}"
    #   when: order_id is none

